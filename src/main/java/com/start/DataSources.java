/** *2016年12月11日, jim.huang, create */package com.start;import com.database.SqlExecutor;import com.zaxxer.hikari.HikariConfig;import com.zaxxer.hikari.HikariDataSource;import io.vertx.core.AbstractVerticle;import io.vertx.core.Future;import io.vertx.core.buffer.Buffer;import io.vertx.core.json.JsonArray;import io.vertx.core.json.JsonObject;import io.vertx.core.logging.Logger;import io.vertx.core.logging.LoggerFactory;import org.springframework.stereotype.Component;import javax.sql.DataSource;import java.util.HashMap;import java.util.Map;import java.util.Properties;/** * @Author jim.huang * @Date 2016年12月11日 */@Componentpublic class DataSources extends AbstractVerticle {    private static Map<String, DataSource> source = new HashMap<String, DataSource>();    private final Logger logger = LoggerFactory.getLogger(DataSources.class);    private static final String config = "config.json";    @Override    public void start(Future<Void> startFuture) throws Exception {        Future<Buffer> fileFuture = Future.future();        vertx.fileSystem().readFile(config, fileFuture.completer());        fileFuture.compose((result) -> {            dataSourceHandler(result);            Future<String> future = Future.future();            vertx.deployVerticle(new SqlExecutor(), future.completer());            return future;        }).setHandler(rs -> {            if (rs.succeeded()) {                logger.info("sql executor ready to work");                startFuture.complete();            } else {                logger.error("sql executor fail to work", rs.cause());                startFuture.fail(rs.cause());            }        });    }    public static DataSource getDataSource(String type) {        return source.get(type);    }    private void dataSourceHandler(Buffer result) {        JsonArray array = result.toJsonArray();        array.forEach(node -> {            JsonObject object = (JsonObject) node;            String db = object.getString("type");            Properties properties = new Properties();            JsonObject pool = object.getJsonObject("pool");            properties.putAll(pool.getMap());            DataSource dataSource = new HikariDataSource(new HikariConfig(properties));            source.put(db, dataSource);        });        logger.info("data source ready");    }    public static DataSource getDefault() {        return getDataSource("mysql");    }}